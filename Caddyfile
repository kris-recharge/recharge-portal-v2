dashboard.rechargealaska.net {
          encode gzip

        @root path /
        redir @root /login 302

        # ---- Next.js (web) ----
        handle /login* {
                reverse_proxy 127.0.0.1:3000 {
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                }
        }

        @app_root path /app
        handle @app_root {
          redir /app/ 302
        }

        # ---- Streamlit (app) served at /app ----

        # Websocket endpoint MUST be able to upgrade cleanly.
        handle /app/_stcore/stream {
                reverse_proxy 127.0.0.1:8501 {
                        transport http {
                                versions 1.1
                        }
                        header_up Host {host}
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                        header_up X-Forwarded-Prefix /app
                }
        }

        # Everything else under /app stays behind your auth check
        handle /app* {
                forward_auth 127.0.0.1:3000 {
                        uri /api/auth/verify
                        copy_headers Cookie
                }

                reverse_proxy 127.0.0.1:8501 {
                        transport http {
                                versions 1.1
                        }
                        header_up Host {host}
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                        header_up X-Forwarded-Prefix /app
                }
        }

        # ---- Streamlit (app) ----

        # Websocket endpoint MUST be able to upgrade cleanly.
        # We rely on the fact that /st page load is auth-gated; the websocket is useless wit>
        handle /st/_stcore/stream {
                reverse_proxy 127.0.0.1:8501 {
                        transport http {
                                versions 1.1
                        }
                        header_up Host {host}
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                        header_up X-Forwarded-Prefix /st
                }
        }

        # Everything else under /st stays behind your auth check
        handle /st* {
                forward_auth 127.0.0.1:3000 {
                        uri /api/auth/verify
                        copy_headers Cookie
                }

                reverse_proxy 127.0.0.1:8501 {
                        transport http {
                                versions 1.1
                        }
                        header_up Host {host}
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                        header_up X-Forwarded-Prefix /st
                }
        }

        # Default: send to Next
        handle {
                reverse_proxy 127.0.0.1:3000 {
                        header_up X-Forwarded-Proto https
                        header_up X-Forwarded-Host {host}
                }
        }
}
