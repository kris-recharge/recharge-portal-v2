dashboard.rechargealaska.net {

  encode gzip

  # --- Matchers ---
  @root path /

  # --- Root redirect to /login ---
  redir @root /login 302

  # --- Next.js (UI + auth + api) ---
  handle /login* {
    reverse_proxy 127.0.0.1:3000
  }

  handle /api/* {
    reverse_proxy 127.0.0.1:3000
  }

  # Protect /app via Next.js auth verify endpoint
  handle /app* {
    forward_auth 127.0.0.1:3000 {
      uri /api/auth/verify
      header_up Cookie {http.request.header.Cookie}
    }
    reverse_proxy 127.0.0.1:3000
  }

  # --- Streamlit behind auth, mounted at /st ---
  handle /st* {
    forward_auth web:3000 {
      uri /api/auth/verify
    }

  reverse_proxy app:8501 {
    header_up Host {http.request.host}
    header_up X-Forwarded-Proto {scheme}
    header_up X-Forwarded-Prefix /st
    header_up Cookie {http.request.header.Cookie}
    }
  }

  handle /_stcore/* {
    forward_auth web:3000 {
      uri /api/auth/verify
    }

  reverse_proxy app:8501 {
    header_up Host {http.request.host}
    header_up X-Forwarded-Proto {scheme}
    header_up X-Forwarded-Prefix /st
    header_up Cookie {http.request.header.Cookie}
    }
  }

  # Everything else -> Next
  handle {
    reverse_proxy 127.0.0.1:3000
  }
}
