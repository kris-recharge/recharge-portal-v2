dashboard.rechargealaska.net {
  encode gzip

  # Always start at login
  @root path /
  redir @root /login 302

  # ---- Next.js (web) ----
  handle /login* {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }

  # (Optional but explicit) Next.js API routes
  handle /api/* {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }

  # ---- Streamlit served at /app ----
  # Ensure /app -> /app/ so Streamlit relative paths behave
  @app_root path /app
  redir @app_root /app/ 302

  # Protect Streamlit websocket with the same auth gate.
  handle /app/_stcore/stream {
    forward_auth 127.0.0.1:3000 {
      uri /api/auth/verify
      copy_headers Cookie
    }

    reverse_proxy 127.0.0.1:8501 {
      transport http {
        versions 1.1
      }
      header_up Host {host}
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Prefix /app
    }
  }

  # Everything else under /app stays behind your auth check
  handle /app* {
    forward_auth 127.0.0.1:3000 {
      uri /api/auth/verify
      copy_headers Cookie
    }

    reverse_proxy 127.0.0.1:8501 {
      transport http {
        versions 1.1
      }
      header_up Host {host}
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Prefix /app
    }
  }

  # /st is no longer a valid base path once Streamlit is configured for /app
  # Redirect any old /st links over to /app.
  handle /st* {
    redir /app{uri} 302
  }

  # Default: send everything else to Next
  handle {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }
}
