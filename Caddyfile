dashboard.rechargealaska.net {
  encode gzip

  # If a protected route returns 401/403, send the browser to /login.
  # (Keeps /app from showing a raw "Unauthorized" page.)
  handle_errors {
    @auth_fail {
      expression {http.error.status_code} in [401, 403]
      path /app*
    }
    redir @auth_fail /login 302
  }

  # Always start at login
  @root path /
  redir @root /login 302

  # ---- Next.js (web) ----
  handle /login* {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }

  # (Optional but explicit) Next.js API routes
  # NextAuth commonly uses /api/auth/signout; keep /api/auth/logout working too.
  handle /api/auth/logout {
    redir /api/auth/signout 302
  }

  handle /api/* {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }

  # ---- Streamlit served at /app ----
  # Ensure /app -> /app/ so Streamlit relative paths behave
  @app_root path /app
  redir @app_root /app/ 302

  # ---- Streamlit internal endpoints (websocket + host-config) ----
  # IMPORTANT:
  # Putting forward_auth in front of Streamlit's websocket endpoint can cause the
  # UI to get stuck in the "half-baked loading" state.
  # We keep the main /app pages auth-gated, but allow Streamlit's internal routes
  # through to the Streamlit backend.
  handle /app/_stcore/* {
    reverse_proxy 127.0.0.1:8501 {
      transport http {
        versions 1.1
      }
      header_up Host {host}
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Prefix /app
    }
  }

  # Everything else under /app stays behind your auth check
  handle /app* {
    forward_auth 127.0.0.1:3000 {
      uri /api/auth/verify

      # MUST forward browser cookies so verify can validate the session
      header_up Cookie {http.request.header.Cookie}

      # Optional context (handy for debugging)
      header_up X-Forwarded-Method {method}
      header_up X-Forwarded-Uri {uri}
    }

    reverse_proxy 127.0.0.1:8501 {
      transport http {
        versions 1.1
      }
      header_up Host {host}
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
      header_up X-Forwarded-Prefix /app
    }
  }

  # /st is no longer a valid base path once Streamlit is configured for /app
  # Redirect any old /st links over to /app.
  handle /st* {
    redir /app{uri} 302
  }

  # Default: send everything else to Next
  handle {
    reverse_proxy 127.0.0.1:3000 {
      header_up X-Forwarded-Proto https
      header_up X-Forwarded-Host {host}
    }
  }
}
